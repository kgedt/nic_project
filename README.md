# nic_project

Групповой проект «RoomTime» — ТЗ (1 месяц)
1) Цели
•	Практика, максимально приближенная к прод: проектирование БД, миграции, кеширование, Docker, планировщик задач, JWT (access+refresh), роли, рейт-лимит, загрузка файлов, масштабируемость модульного монолита.
•	Покрытие актуального стека бэкенд-разработчика.
2) Архитектура
•	Модульный монолит.
•	REST API + Swagger (обязательно).
•	Stateless-приложение; общие PostgreSQL и Redis.
3) Технологии
•	Язык/фреймворк (на выбор команды): Python / Go / Node.js / .NET.
•	БД: PostgreSQL.
•	Redis: кеш, локи, рейт-лимит, идемпотентность.
•	Планировщик задач: по стеку (Celery / Hangfire / Bull / cron и т.п.).
•	Деплой: Docker Compose (локально).
•	Логи: структурированные.
4) Обязательная функциональность
•	JWT аутентификация (access+refresh), ротация/ревокация refresh-токенов.
•	Роли: user, admin (RBAC на эндпоинтах).
•	Загрузка файлов к ресурсу с лимитом размера и валидацией типов.
•	Email-восстановление пароля (reset-flow).
•	Swagger покрывает все публичные эндпоинты для Go стэка можно использовать альтернативы(Postman,Bruno).
5) Домен и сущности (минимум)
Сущность	Ключевые поля
User	id, email, password_hash, role, created_at
RefreshToken	id, user_id, token, expires_at, revoked
Resource	id, name, location, capacity, file_path?, is_active
TimeSlot	id, resource_id, starts_at, ends_at, status [available | held | booked]
Booking	id, user_id, resource_id, starts_at, ends_at, status [pending | confirmed | cancelled], created_at
FileUpload	id, owner_user_id, path, size_bytes, mime, created_at
AuditLog	id, actor_user_id, action, entity, entity_id, meta, ts
Индексы и ограничения:
•	(resource_id, starts_at), (starts_at, ends_at), уникальность пересечений бронирований.
•	(user_id, created_at) для пользовательских выборок.
•	Все времена в БД — UTC.
________________________________________
6) Бизнес-логика (подробно)
6.1 Управление ресурсами (admin)
•	Создание/редактирование/деактивация ресурса (is_active=false скрывает его из поиска).
•	Поля: name, location, capacity, опциональный прикреплённый файл (изображение/правила).
•	При изменении ресурса: инвалидация кешей доступности по затронутым датам.
6.2 Слоты и доступность
•	TimeSlot — атомарная единица бронирования (например, 30/60 минут).
•	Слоты генерируются один раз скриптом/ручным вводом (admin) либо автоматически при создании ресурса.
•	Доступность на дату = все available слоты по ресурсу в интервале [00:00; 23:59].
•	Кеш доступности в Redis: ключ avail:{resource_id}:{YYYY-MM-DD}, TTL 30–120 сек.
•	Инвалидация кеша при любых изменениях статусов слотов (hold, confirm, cancel).
6.3 Держание слота (Hold)
•	Пользователь инициирует POST /bookings/hold c resource_id, starts_at, ends_at.
•	Сервис проверяет, что все слоты в диапазоне — available.
•	Ставит распределённый лок в Redis: hold:{resource_id}:{starts_at}-{ends_at} через SET NX EX <ttl>.
•	Помечает слоты как held (в БД), возвращает hold_id и время истечения (например, 2–5 минут).
•	Повторные попытки удержать тот же диапазон в период холда — отказ (конфликт).
6.4 Подтверждение бронирования (Confirm)
•	POST /bookings/confirm принимает hold_id (или тот же набор параметров + Idempotency-Key).
•	Проводится транзакция:
1.	Проверка наличия валидного hold (лок жив, слоты всё ещё held).
2.	Проверка коллизий (нет пересечений с уже booked).
3.	Создание Booking(status=pending→confirmed), проставление слотов в booked.
4.	Удаление/истечение локов hold:*.
•	Идемпотентность: заголовок Idempotency-Key → Redis-ключ с TTL, чтобы повторный confirm не создал дубль, а вернул прежний результат.
•	Рейт-лимит на confirm: 10 req/мин на пользователя.
6.5 Отмена бронирования (Cancel)
•	POST /bookings/{id}/cancel:
o	Владелец брони или admin.
o	В транзакции слоты возвращаются в available (если бронь ещё актуальна).
o	Инвалидация кеша доступности по затронутым датам.
6.6 Истечение холдов
•	Фоновая задача release-holds (каждые 1–5 минут):
o	Находит слоты в статусе held, чей TTL локов истёк.
o	Возвращает их в available.
o	Чистит устаревшие Redis-локи/артефакты.
o	Инвалидирует кеши доступности.
6.7 Статусы и инварианты
•	Слот не может одновременно быть held и booked.
•	booked можно изменить только через отмену.
•	Бронь не может быть confirmed, если хоть один слот недоступен.
•	При падении сервиса инварианты восстанавливаются крон-задачей.
6.8 Загрузка файлов
•	POST /resources/{id}/file: лимит размера (конфиг), whitelist MIME (например, image/*, application/pdf).
•	Файл сохраняется локально (volume), метаданные — в FileUpload, ссылка — в Resource.file_path.
•	cleanup-uploads раз в сутки удаляет «осиротевшие» файлы, не связанные с ресурсами.
6.9 Аутентификация и роли
•	Регистрация, логин, refresh, logout, forgot/reset пароль по email-ссылке.
•	Роли:
o	user: просмотр ресурсов и доступности, создание/отмена своих бронирований, загрузка файла к ресурсу запрещена.
o	admin: полный CRUD по ресурсам и слотам, просмотр всех бронирований, управление статусами.
•	Рейт-лимит:
o	/auth/login: 5 запросов/мин на IP+email.
o	/bookings/confirm: 10 запросов/мин на пользователя.
6.10 Валидация и ошибки
•	Валидация DTO/типов/форматов дат (ISO-8601).
•	Единый формат ошибок с кодами и полем details для валидации.
•	Пагинация: limit/offset или cursor (на выбор команды), сортировка/фильтры по дате/ресурсу/статусу.
6.11 Кеш-стратегия
•	Кеш только там, где выигрываем: доступность, справочники ресурсов.
•	Инвалидация по событиям (confirm/cancel/resource update), плюс короткий TTL.
•	Персональные выборки не кешируются.
6.12 Аудит
•	Любые изменения статусов/CRUD-операции фиксируются в AuditLog с actor_user_id, action, entity, entity_id, meta, ts.
6.13 Архивирование
•	archive-bookings раз в сутки переводит завершённые брони в архивный статус (опционально — отдельная таблица summary для отчётов).
________________________________________
7) Минимальный набор эндпоинтов
Auth
•	POST /auth/register
•	POST /auth/login
•	POST /auth/refresh
•	POST /auth/logout
•	POST /auth/forgot
•	POST /auth/reset
•	GET /me
Resources
•	GET /resources
•	GET /resources/{id}
•	POST /resources [admin]
•	PUT /resources/{id} [admin]
•	DELETE /resources/{id} [admin]
•	POST /resources/{id}/file (загрузка файла)
Availability / Bookings
•	GET /resources/{id}/availability?date=YYYY-MM-DD
•	POST /bookings/hold
•	POST /bookings/confirm (Idempotency-Key поддерживается)
•	POST /bookings/{id}/cancel
•	GET /bookings/me
Docs
•	GET /docs (Swagger UI)
________________________________________
8) Cron / фоновые задачи
•	release-holds — каждые 1–5 минут: освобождение просроченных холдов.
•	cleanup-uploads — раз в сутки: удаление «осиротевших»/устаревших файлов.
•	archive-bookings — раз в сутки: финализация завершённых бронирований.
________________________________________
9) Docker-окружение (Compose)
Сервисы:
•	app (приложение)
•	postgres (volume + init)
•	redis
•	mailhog или SMTP-мок (по желанию)
•	volume для uploads
Файл .env.example обязателен.
________________________________________
10) Документация
•	Swagger: все эндпоинты, модели, коды ошибок, примеры.
•	README: запуск через Docker Compose, миграции, переменные окружения.
________________________________________
11) Git-flow
•	Ветки: main, develop, feature/*.
•	PR-ревью перед merge в develop/main.
________________________________________
12) Критерии приёмки
•	JWT auth (access+refresh) с ротацией/ревокацией.
•	RBAC на эндпоинтах.
•	Миграции применяются командой; сиды создают стартовые данные.
•	Redis используется как минимум для кеша и lock/rate-limit/идемпотентности.
•	Cron-задачи исполняются и демонстрируются.
•	Docker Compose поднимает весь стек.
•	Swagger доступен и актуален.
•	Файлы загружаются с ограничениями.
•	Логи структурированы; ошибки имеют корректные коды и полезные payload’ы.
________________________________________
Deadline (4 недели; ревью каждые 2 недели)
